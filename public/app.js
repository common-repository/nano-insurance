const $=jQuery;class NanoInsurance{constructor(){this.container=document.getElementById("ni-nanoinsurance"),this.container&&this.isStoreActive()}init(){this.button=document.getElementById("ni-buy-policy"),this.shakeElement=document.querySelector(".ni-checkbox"),this.agreeCheckbox=document.getElementById("ni-terms-conditions"),this.priceEl=document.getElementById("ni-price"),this.getLocalStorage(),this.container.classList.add(`ni-${this.state?this.state:"offer"}`),this.agreed&&(this.agreeCheckbox.checked=!0),this.updateHTML(),this.getPolicyPrice(),$("body").on("click touch","#ni-buy-policy",t=>{if("offer"===this.state&&!this.agreed)return this.shakeElement.classList.remove("ni-shake"),void setTimeout(()=>{this.shakeElement.classList.add("ni-shake")},100);this.button.classList.add("ni-disabled");const e="offer"!==this.state?"offer":"bought";"offer"===e?this.removeFee():"bought"===e&&this.addFee()}),this.agreeCheckbox.addEventListener("click",()=>{this.agreed=!this.agreed,this.setLocalStorage()}),this.agreeCheckbox.addEventListener("touch",()=>{this.agreed=!this.agreed,this.setLocalStorage()}),this.opener=document.getElementById("nano-insurance-opener"),this.opener&&(this.opener.addEventListener("click",()=>{this.showModal()}),this.opener.addEventListener("touch",()=>{this.showModal()}),document.addEventListener("click",t=>{this.closeModal(t)}),document.addEventListener("touch",t=>{this.closeModal(t)})),setInterval(()=>{this.getPolicyPrice()},400)}closeModal(t){this.container.contains(t.target)||this.container.setAttribute("data-state","closed")}showModal(){"closed"===this.container.getAttribute("data-state")?this.container.setAttribute("data-state","opened"):this.container.setAttribute("data-state","closed")}isStoreActive(){$.post(`${NanoInsuranceSettings.ajaxurl}?action=nano_insurance_is_active`,{},t=>{1==t?(this.container.style.display="block",this.init()):this.container.style.display="none"}).fail(()=>this.container.style.display="none")}getPolicyPrice(t=null){$.post(`${NanoInsuranceSettings.ajaxurl}?action=nano_insurance_policy`,{},t=>{const e=JSON.parse(t);this.updatePrice(e)})}addFee(){$.post(`${NanoInsuranceSettings.ajaxurl}?action=nano_insurance_add_policy`,{},t=>{this.changeState("bought"),this.triggerCartTotalsUpdate(),this.button.classList.remove("ni-disabled")})}removeFee(t=null){$.post(`${NanoInsuranceSettings.ajaxurl}?action=nano_insurance_remove_policy`,{},t=>{this.changeState("offer"),this.triggerCartTotalsUpdate(),this.button.classList.remove("ni-disabled")})}changeState(t){this.container.classList.remove(`ni-${this.state}`),this.state=t,this.setLocalStorage(),this.container.classList.add(`ni-${this.state}`),this.updateHTML()}triggerCartTotalsUpdate(){if("checkout"===NanoInsuranceSettings.page)$("body").trigger("update_checkout");else if("cart"===NanoInsuranceSettings.page){const t=$("[name='update_cart']");t.removeAttr("disabled"),t.trigger("click"),t.attr("disabled")}}updatePrice(t=null){t&&`${t.price}`!=`${this.policyPrice}`&&(this.cartTotal=parseFloat(t.cartTotal),this.policyPrice=parseFloat(t.price),this.setLocalStorage(),this.updateHTML(),this.triggerCartTotalsUpdate())}updateHTML(){"offer"===this.state&&this.policyPrice?this.priceEl.innerHTML=this.policyPrice.toFixed(2):"bought"===this.state&&this.policyPrice&&this.cartTotal&&(this.priceEl.innerHTML=(this.policyPrice+parseFloat(this.cartTotal)).toFixed(2))}getLocalStorage(){let t=null;(t=localStorage.getItem("NanoInsurance"))||(this.setLocalStorage(),t=localStorage.getItem("NanoInsurance")),Object.assign(this,JSON.parse(t))}setLocalStorage(){localStorage.setItem("NanoInsurance",JSON.stringify({state:this.state?this.state:"offer",policyPrice:this.policyPrice?this.policyPrice:null,cartTotal:this.cartTotal?this.cartTotal:null,currency:this.currency?this.currency:"",agreed:!!this.agreed&&this.agreed}))}}new NanoInsurance;